<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrato da Comissão</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fundo_comissao.css') }}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-popup" style="position:fixed; top:40px; left:50%; transform:translateX(-50%); z-index:2000;">
                {% for category, message in messages %}
                    <div class="flash-popup {{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
            <script>
                setTimeout(function() {
                    var popup = document.getElementById('flash-popup');
                    if (popup) popup.style.display = 'none';
                }, 4000);
            </script>
            <style>
                @keyframes fadeOutFlash {
                    to { opacity: 0; }
                }
                .flash-popup {
                    color: #fff;
                    padding: 16px 32px;
                    border-radius: 12px;
                    font-size: 1.15rem;
                    margin: 8px 0;
                    animation: fadeOutFlash 0.5s linear 3.5s forwards;
                }
                .flash-popup.success {
                    background: #28a745;
                    box-shadow: 0 4px 16px rgba(40,167,69,0.15);
                }
                .flash-popup.error {
                    background: #dc3545;
                    box-shadow: 0 4px 16px rgba(220,53,69,0.15);
                }
            </style>
        {% endif %}
    {% endwith %}
    <div class="main-wrapper">
        <div class="topbar">
            <div class="topbar-title"><i class='bx bxs-bank'></i> Extrato da Comissão</div>
            <div class="topbar-actions">
                {% if session.get('tipo_usuario') == 'admin' %}
                <button type="button" class="btn-primary" onclick="openExpenseModal()">
                    <i class='bx bx-plus'></i> Nova Despesa
                </button>
                {% endif %}
                <a href="{{ url_for('home') }}" class="btn-back" aria-label="Voltar à Home">
                    <i class='bx bx-arrow-back'></i> Voltar à Home
                </a>
            </div>
        </div>
        <div class="content-section">
            <aside class="sidebar">
                <form method="get" class="filter-form" aria-label="Filtrar registros">
                    <div class="filter-group">
                        <label for="tipo"><i class='bx bx-filter'></i> Tipo</label>
                        <select name="tipo" id="tipo">
                            <option value="" {% if not filtro_tipo %}selected{% endif %}>Todos</option>
                            <option value="arrecadacao" {% if filtro_tipo=='arrecadacao' %}selected{% endif %}>Arrecadações</option>
                            <option value="despesa" {% if filtro_tipo=='despesa' %}selected{% endif %}>Despesas</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="categoria">Categoria</label>
                        <select name="categoria" id="categoria">
                            <option value="" {% if not filtro_categoria %}selected{% endif %}>Todas</option>
                            {% for t in tipos %}
                            <option value="{{ t.tipo }}" {% if filtro_categoria == t.tipo %}selected{% endif %}>{{ t.tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="sidebar_produto">Produto</label>
                        <select name="produto" id="sidebar_produto">
                            <option value="" {% if not filtro_produto %}selected{% endif %}>Todos</option>
                            {% for prod in produtos %}
                            <option value="{{ prod.produto }}" {% if filtro_produto == prod.produto %}selected{% endif %}>{{ prod.produto }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="ordenacao"><i class='bx bx-sort'></i> Ordenar</label>
                        <select name="ordenacao" id="ordenacao">
                            <option value="" {% if not ordenacao %}selected{% endif %}>Mais recente</option>
                            <option value="maior_valor" {% if ordenacao=='maior_valor' %}selected{% endif %}>Maior valor</option>
                            <option value="menor_valor" {% if ordenacao=='menor_valor' %}selected{% endif %}>Menor valor</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="data_inicio"><i class='bx bx-calendar'></i> Data início</label>
                        <input type="date" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
                    </div>
                    <div class="filter-group">
                        <label for="data_fim"><i class='bx bx-calendar'></i> Data fim</label>
                        <input type="date" id="data_fim" name="data_fim" value="{{ data_fim }}">
                    </div>
                    <div class="filter-group">
                    <button type="submit" class="btn-modern">Filtrar <i class='bx bx-check'></i></button>
                </form>
            </aside>
            <main class="main-content">
                <div class="stats-section">
                    <div class="stat-card fundo-card" tabindex="0" aria-label="Fundo disponível">
                        <h3>R$ {{ "%.2f"|format(fundo_disponivel|default(0.00)) }}</h3>
                        <p>Fundo disponível</p>
                    </div>
                    <div class="stat-card arrecadacao-card" tabindex="0" aria-label="Total de Arrecadações">
                        <h3>R$ {{ "%.2f"|format(total_arrecadacoes|default(0.00)) }}</h3>
                        <p>Total de Arrecadações</p>
                    </div>
                    <div class="stat-card despesa-card" tabindex="0" aria-label="Total de Despesas">
                        <h3>R$ {{ "%.2f"|format(total_despesas|default(0.00)) }}</h3>
                        <p>Total de Despesas</p>
                    </div>
                    <div class="stat-card filtro-card" tabindex="0" aria-label="Total do Filtro">
                        <h3>R$ {{ "%.2f"|format(total_filtro|default(0.00)) }}</h3>
                        <p>Total do Filtro</p>
                    </div>
                </div>
                <div class="table-container">
                    <table class="students-table" id="fundTable" aria-label="Tabela de despesas e arrecadações">
                        <thead>
                            <tr>
                                {% if session.get('tipo_usuario') == 'admin' %}
                                <th>Nome/Aluno</th>
                                {% endif %}
                                <th>Descrição</th>
                                <th>Produto</th>
                                <th>Valor (R$)</th>
                                <th>Data</th>
                                <th>Tipo</th>
                                {% if session.get('tipo_usuario') == 'admin' %}
                                <th>Ações</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% if registros_paginados %}
                                {% for reg in registros_paginados %}
                                <tr>
                                    {% if session.get('tipo_usuario') == 'admin' %}
                                    <td>{{ reg.nome }}</td>
                                    {% endif %}
                                    <td>{{ reg.descricao }}</td>
                                    <td>{{ reg.produto if reg.produto else '-' }}</td>
                                    <td class="{% if reg.tipo == 'despesa' %}valor-despesa{% else %}valor-arrecadacao{% endif %}">
                                        {% if reg.tipo == 'despesa' %}- R$ {% else %}+ R$ {% endif %}{{ "%.2f"|format(reg.valor) }}
                                    </td>
                                    <td>{{ reg.data.strftime('%d/%m/%Y') if reg.data else reg.data }}</td>
                                    <td>
                                        {% if reg.tipo == 'despesa' %}
                                            <span style="background:#dc3545;color:#fff;padding:4px 12px;border-radius:8px;font-size:0.98rem;">Despesa</span>
                                        {% else %}
                                            <span style="background:#28a745;color:#fff;padding:4px 12px;border-radius:8px;font-size:0.98rem;">Arrecadação</span>
                                        {% endif %}
                                    </td>
                                    {% if session.get('tipo_usuario') == 'admin' %}
                                    <td>
                                        <button onclick="openViewModal(this)" class="btn-edit" title="Ver detalhes" data-id="{{ reg.id }}" data-tipo="{{ reg.tipo }}" data-nome="{{ reg.nome }}" data-descricao="{{ reg.descricao }}" data-produto="{{ reg.produto }}" data-valor="{{ reg.valor }}" data-data="{{ reg.data.isoformat() if reg.data else '' }}" data-admin="{{ reg.admin_nome }}">
                                            <i class='bx bx-show'></i>
                                        </button>
                                       
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="7" style="color:#666; text-align:center; padding:20px;">Nenhum registro encontrado.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="pagination-container">
                        <nav aria-label="Paginação de registros">
                            <ul class="pagination-list">
                                {% for page_num in range(1, total_paginas+1) %}
                                    <li>
                                        {% if page_num == pagina_atual %}
                                            <span class="pagination-current">{{ page_num }}</span>
                                        {% else %}
                                            <a href="{{ url_for('fundo_comissao', pagina=page_num, tipo=filtro_tipo, categoria=filtro_categoria, produto=filtro_produto, data_inicio=data_inicio, data_fim=data_fim, ordenacao=ordenacao) }}" class="pagination-link">{{ page_num }}</a>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </nav>
                    </div>
                </div>
                {% if not registros_paginados %}
                <div class="empty-state">
                    <i class='bx bx-user-x'></i>
                    <p>Nenhum registro encontrado.</p>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
    <!-- Modal Nova Despesa -->
    {% if session.get('tipo_usuario') == 'admin' %}
    <div id="expenseModal" class="modal" aria-modal="true" role="dialog" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeExpenseModal()" aria-label="Fechar modal">&times;</span>
            <h2>Adicionar Nova Despesa</h2>
            <form class="add-expense-form" method="POST" action="{{ url_for('adicionar_despesa') }}">
                <div class="form-group">
                    <label for="nome">Nome da despesa</label>
                    <input type="text" id="nome" name="nome" required>
                </div>
                <div class="form-group">
                    <label for="descricao">Descrição</label>
                    <textarea id="descricao" name="descricao" required></textarea>
                </div>
                <div class="form-group">
                    <label for="valor">Valor (R$)</label>
                    <input type="number" id="valor" name="valor" step="0.01" min="0.01" max="999999999.99" required>
                </div>
                <div class="form-group">
                    <label for="tipo">Categoria</label>
                    <select id="modal_tipo" name="tipo" required>
                        <option value="" disabled selected>Selecione uma categoria</option>
                        <option value="Produtos">Produtos</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Rifas">Rifas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="produto">Produto:</label>
                    <select id="produto" name="produto" disabled required>
                        <option value="">Primeiro selecione a categoria</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn-primary">Salvar</button>
                    <button type="button" class="btn-back" onclick="closeExpenseModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    <!-- Modal Ver Administrador -->
    <div id="viewModal" class="modal" aria-modal="true" role="dialog" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeViewModal()" aria-label="Fechar modal">&times;</span>
            <h2>Detalhes do Registro</h2>
            <div id="modalDetails" style="color: #060049; font-size: 1rem; margin-bottom: 20px;">
                <!-- Details will be populated here -->
            </div>
            <form id="deleteForm" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este registro?')">
                <input type="hidden" id="deleteId" name="">
                <button type="submit" class="btn-delete" style="width: 100%;">
                    <i class='bx bx-trash'></i> Excluir
                </button>
            </form>
            <div class="button-group" style="margin-top: 12px;">
                <button type="button" class="btn-back" onclick="closeViewModal()">Fechar</button>
            </div>
        </div>
    </div>
    <script>
        function openExpenseModal() {
            document.getElementById('expenseModal').classList.add('show');
            document.getElementById('nome').focus();
        }
        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('show');
        }
        function openViewModal(button) {
            const modal = document.getElementById('viewModal');
            const detailsDiv = document.getElementById('modalDetails');
            const deleteForm = document.getElementById('deleteForm');
            const deleteIdInput = document.getElementById('deleteId');

            const registro = {
                id: button.dataset.id,
                tipo: button.dataset.tipo,
                nome: button.dataset.nome,
                descricao: button.dataset.descricao,
                produto: button.dataset.produto,
                valor: button.dataset.valor,
                data: button.dataset.data,
                admin_nome: button.dataset.admin
            };

            // Clear previous content
            detailsDiv.innerHTML = '';

            // Build details content
            let html = '<p><strong>Administrador:</strong> ' + (registro.admin_nome || 'Não informado') + '</p>';

            detailsDiv.innerHTML = html;

            // Setup delete form action and hidden input name/id
            if (registro.tipo === 'despesa') {
                deleteForm.action = "{{ url_for('deletar_despesa') }}";
                deleteIdInput.name = 'id_despesa';
            } else {
                deleteForm.action = "{{ url_for('deletar_arrecadacao') }}";
                deleteIdInput.name = 'id_arrecadacao';
            }
            deleteIdInput.value = registro.id;

            modal.classList.add('show');
        }
        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('show');
        }
        window.onclick = function(event) {
            const expenseModal = document.getElementById('expenseModal');
            const viewModal = document.getElementById('viewModal');
            if (event.target === expenseModal) {
                closeExpenseModal();
            }
            if (event.target === viewModal) {
                closeViewModal();
            }
        }
        // Salva valor do input 'valor' no localStorage
        const expenseValorInput = document.getElementById('valor');
        if (expenseValorInput) {
            const savedExpenseValor = localStorage.getItem('fundo_comissao_despesa_valor');
            if (savedExpenseValor) {
                expenseValorInput.value = savedExpenseValor;
            }
            expenseValorInput.addEventListener('input', function() {
                localStorage.setItem('fundo_comissao_despesa_valor', this.value);
            });
        }


        // Update produto options based on selected tipo in modal
        document.getElementById('modal_tipo').addEventListener('change', function() {
            const tipoSelecionado = this.value;
            const produtoSelect = document.getElementById('produto');

            if (tipoSelecionado) {
                // Fazer requisição AJAX para obter os produtos do tipo selecionado
                fetch(`/get_filtros/${tipoSelecionado}`)
                    .then(response => response.json())
                    .then(produtos => {
                        // Limpar opções existentes
                        produtoSelect.innerHTML = '<option value="" disabled selected>Selecione o produto</option>';

                        // Adicionar novas opções
                        produtos.forEach(produto => {
                            const option = document.createElement('option');
                            option.value = produto;
                            option.textContent = produto;
                            produtoSelect.appendChild(option);
                        });

                        // Habilitar o select de produto
                        produtoSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar produtos:', error);
                        produtoSelect.innerHTML = '<option value="" disabled selected>Erro ao carregar os produtos</option>';
                    });
            } else {
                // Se nenhum tipo foi selecionado, desabilitar o select de produto
                produtoSelect.innerHTML = '<option value="" disabled selected>Primeiro selecione a categoria</option>';
                produtoSelect.disabled = true;
            }
        });

        // Update sidebar product options based on selected category
        document.getElementById('categoria').addEventListener('change', function() {
            const categoriaSelecionada = this.value;
            const produtoSelect = document.getElementById('sidebar_produto');

            if (categoriaSelecionada) {
                // Habilitar o select de produto quando uma categoria é selecionada
                produtoSelect.disabled = false;

                // Fazer requisição AJAX para obter os produtos da categoria selecionada
                fetch(`/get_produtos_por_categoria/${categoriaSelecionada}`)
                    .then(response => response.json())
                    .then(produtos => {
                        // Limpar opções existentes
                        produtoSelect.innerHTML = '<option value="" {% if not filtro_produto %}selected{% endif %}>Todos</option>';

                        // Adicionar novas opções
                        produtos.forEach(produto => {
                            const option = document.createElement('option');
                            option.value = produto;
                            option.textContent = produto;
                            produtoSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao carregar produtos por categoria:', error);
                        // Em caso de erro, manter apenas a opção "Todos"
                        produtoSelect.innerHTML = '<option value="" {% if not filtro_produto %}selected{% endif %}>Todos</option>';
                    });
            } else {
                // Se nenhuma categoria foi selecionada, desabilitar o select de produto
                produtoSelect.innerHTML = '<option value="" {% if not filtro_produto %}selected{% endif %}>Todos</option>';
                produtoSelect.disabled = true;
            }
        });

        // Initialize product dropdown as disabled on page load
        document.addEventListener('DOMContentLoaded', function() {
            const produtoSelect = document.getElementById('sidebar_produto');
            const categoriaSelect = document.getElementById('categoria');

            // Se não há categoria selecionada, desabilitar o select de produto
            if (!categoriaSelect.value) {
                produtoSelect.disabled = true;
            }

            // Aplicar ajuste de fonte para valores grandes
            ajustarFontesValores();
        });

        // Função para ajustar o tamanho da fonte baseado no valor
        function ajustarFontesValores() {
            const valorCells = document.querySelectorAll('.students-table td:nth-child(4)'); // Coluna de valores

            valorCells.forEach(cell => {
                // Remover classes anteriores
                cell.classList.remove('valor-grande', 'valor-muito-grande', 'valor-extremo');

                // Extrair o valor numérico (removendo R$, espaços, sinais)
                const texto = cell.textContent.trim();
                const valorMatch = texto.match(/[\d.,]+/);
                if (valorMatch) {
                    const valor = parseFloat(valorMatch[0].replace(/[.,]/g, function(match) { return match === ',' ? '.' : ''; }));

                    // Aplicar classe baseada no valor absoluto
                    if (valor >= 1000000) { // 1 milhão ou mais
                        cell.classList.add('valor-extremo');
                    } else if (valor >= 100000) { // 100 mil ou mais
                        cell.classList.add('valor-muito-grande');
                    } else if (valor >= 10000) { // 10 mil ou mais
                        cell.classList.add('valor-grande');
                    }
                }
            });
        }

        // Reajustar fontes quando filtros são aplicados
        document.querySelector('.filter-form').addEventListener('submit', function() {
            // Aguardar um pouco para os dados serem carregados
            setTimeout(ajustarFontesValores, 500);
        });
    </script>
</body>
</html>
